<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Blockchain Escrow</title>

  <!-- Modern font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #0d0e14;
      --secondary: #a89464;
      --bg: #f4f4f4;
      --card-bg: #ffffff;
      --success: #d1fae5;
      --error: #fee2e2;
      --info: #e0f2fe;
    }

    body {
      margin: 0;
      background-color: var(--bg);
      color: var(--primary);
      font-family: 'Inter', sans-serif;
    }

    .container {
      max-width: 800px;
      margin: 50px auto;
      background-color: var(--card-bg);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
    }

    h1, h2, h3 {
      color: var(--primary);
    }

    label {
      font-weight: 600;
      margin-top: 12px;
      display: block;
    }

    input, select, button {
      display: block;
      width: 100%;
      margin-top: 8px;
      margin-bottom: 20px;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
    }

    button {
      background-color: var(--primary);
      color: white;
      border: none;
      font-weight: 600;
      transition: 0.3s;
    }

    button:hover:not([disabled]) {
      background-color: #1a1c28;
      cursor: pointer;
    }

    button:disabled {
      background-color: #888;
      cursor: not-allowed;
    }

    .card {
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      background-color: var(--card-bg);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .status-bar {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 20px 0;
    }

    .status-step {
      padding: 12px;
      border-radius: 8px;
      background-color: #eee;
      font-weight: 500;
      position: relative;
      padding-left: 40px;
    }

    .status-step::before {
      content: '⏳';
      position: absolute;
      left: 12px;
      top: 12px;
    }

    .status-step.done {
      background-color: var(--success);
    }

    .status-step.done::before {
      content: '✅';
    }

    .response-card {
      padding: 18px;
      border-radius: 10px;
      margin-top: 30px;
      border-left: 6px solid var(--secondary);
      background-color: var(--info);
      color: var(--primary);
      font-size: 16px;
      font-weight: 500;
    }

    @media (max-width: 600px) {
      .container {
        padding: 20px;
      }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.5.0/ethers.umd.min.js"></script>
  <script type="text/javascript" src="./escrowABI.js"></script>
</head>

<body onload="checkWallet()">
  <div class="container">
    <h1>Blockchain Escrow</h1>

    <div class="status-bar">
      <div class="status-step" id="status-wallet">Connecting wallet...</div>
      <div class="status-step" id="status-contract">Connecting contract...</div>
      <div class="status-step" id="status-ready">Ready for transactions</div>
    </div>

    <div class="card">
      <h2>Open Escrow</h2>
      <label for="amount">Amount</label>
      <input type="number" id="amount" min="1" />

      <button id="approveButton" onclick="approveButton()">Approve Token Transfer</button>

      <label for="sellerAddress">Seller Address</label>
      <input type="text" id="sellerAddress" disabled />

      <label for="mediatorAddress">Mediator Address</label>
      <input type="text" id="mediatorAddress" disabled />

      <button id="openButton" onclick="openEscrow()" disabled>Open Escrow</button>
    </div>

    <div class="card">
      <h2>Close Escrow</h2>
      <label for="closeOption">Select Option</label>
      <select id="closeOption">
        <option value="paySeller">Pay Seller</option>
        <option value="returnFunds">Return Funds</option>
      </select>
      <button id="closeButton" onclick="closeEscrow()">Close Escrow</button>
    </div>

    <div id="responseMessage" class="response-card">Status will appear here...</div>
  </div>

  <script>
    let myWallet, myContract, provider, signer;

    async function checkWallet() {
      const statusWallet = document.getElementById('status-wallet');
      const statusContract = document.getElementById('status-contract');
      const statusReady = document.getElementById('status-ready');
      const response = document.getElementById('responseMessage');

      try {
        let accounts = await ethereum.request({ method: 'eth_accounts' });
        if (!accounts.length) {
          await ethereum.request({ method: 'eth_requestAccounts' });
          accounts = await ethereum.request({ method: 'eth_accounts' });
        }
        myWallet = accounts[0];
        statusWallet.classList.add('done');

        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        myContract = new ethers.Contract(escrowContractAddress, escrowABI, provider);
        statusContract.classList.add('done');

        const buyer = await myContract.buyerAddress();
        if (buyer === '0x0000000000000000000000000000000000000000') {
          document.getElementById('closeButton').disabled = true;
        }

        statusReady.classList.add('done');
        response.innerHTML = "✓ Wallet connected. Contract ready.";
      } catch (e) {
        console.error(e);
        response.innerHTML = `❌ Error: ${e.message}`;
        response.style.backgroundColor = 'var(--error)';
      }
    }

    async function approveButton() {
      const amt = document.getElementById('amount').value;
      const response = document.getElementById('responseMessage');
      if (!amt || amt <= 0) {
        response.innerHTML = 'Enter a valid amount.';
        return;
      }

      try {
        response.innerHTML = 'Approving token transfer...';
        const approveAmt = BigInt(amt * 10 ** 18);
        const tokenContract = new ethers.Contract(escrowTokenAddress, escrowTokenABI, signer);
        const tx = await tokenContract.approve(escrowContractAddress, approveAmt);
        await tx.wait();

        response.innerHTML = '✅ Token transfer approved.';
        document.getElementById('sellerAddress').disabled = false;
        document.getElementById('mediatorAddress').disabled = false;
        document.getElementById('openButton').disabled = false;
        document.getElementById('approveButton').disabled = true;
      } catch (e) {
        response.innerHTML = `❌ Error: ${e.message}`;
      }
    }

    async function openEscrow() {
      const amount = document.getElementById('amount').value;
      const seller = document.getElementById('sellerAddress').value;
      const mediator = document.getElementById('mediatorAddress').value;
      const response = document.getElementById('responseMessage');

      if (!amount || !seller || !mediator) {
        response.innerHTML = 'Fill in all fields.';
        return;
      }

      try {
        const contractWithSigner = myContract.connect(signer);
        const tx = await contractWithSigner.openEscrow(BigInt(amount * 10 ** 18), seller, mediator);
        await tx.wait();

        response.innerHTML = '✅ Escrow account opened.';
        document.getElementById('openButton').disabled = true;
        document.getElementById('sellerAddress').disabled = true;
        document.getElementById('mediatorAddress').disabled = true;
      } catch (e) {
        response.innerHTML = `❌ Error: ${e.message}`;
      }
    }

    async function closeEscrow() {
      const option = document.getElementById('closeOption').value;
      const response = document.getElementById('responseMessage');
      const contractWithSigner = myContract.connect(signer);

      try {
        const tx = await contractWithSigner.closeEscrow(option === 'paySeller' ? 1 : 0);
        await tx.wait();
        response.innerHTML = '✅ Escrow closed.';
      } catch (e) {
        response.innerHTML = `❌ Error: ${e.message}`;
      }
    }
  </script>
</body>
</html>

